# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Machina Ludens is an AI creature-breeding game built as a static web app. Players tend a population of AI "bots" that evolve Sokoban puzzle preferences through genetic algorithms. Bots develop heritable taste (genome), curate puzzles for the player, and reproduce based on player ratings — creating a co-evolutionary loop. The theoretical foundation comes from Huizinga's *Homo Ludens* (play produces culture).

## Running the App

No build step or dependencies. Open `index.html` in a browser (or use any static file server). ES modules require serving over HTTP — `python -m http.server` or VS Code Live Server both work. The `prototype/` directory contains an earlier standalone version and is not the active codebase.

## Architecture

**Three-layer module structure** using vanilla ES modules (`<script type="module">`):

- **`shared/`** — Domain logic, no DOM access. Designed to eventually work in both browser and server.
  - `tiles.js` — `TILES` enum (FLOOR=0, WALL=1, TARGET=2, BOX=3, PLAYER=4, BOX_ON_TARGET=5). Single source of truth.
  - `generator.js` — `SokobanGenerator` class. Reverse-play algorithm (Taylor & Parberry 2011) with 4 style algorithms: random clusters, recursive subdivision (maze), organic caves (cellular automata), and BSP rooms with internal clusters. Weight-based dispatch selects primary algorithm, then optionally applies a secondary overlay. Includes connectivity enforcement, deadlock detection (corner + freeze), and progressive relaxation on generation failure.
  - `genome.js` — `Genome`, `Population`, and `Bot` classes. Genome carries 11 genes: 4 structural (gridSize, boxCount, complexity, wallDensity), 4 style weights (styleClusters/Maze/Caves/ClusteredRooms), 3 visual (palette, tileStyle, decoration). Population implements selection (top 50%), crossover, mutation (20% rate), and elitism. Bot wraps a Genome with procedurally generated name/personality/colors/sprite and a curation system (affinity-based genome preference).

- **`client/`** — Browser-only UI and game loop.
  - `main.js` — Entry point, creates `Game` instance and exposes it to `window.game` for HTML onclick handlers.
  - `game.js` — `Game` class: canvas rendering, Sokoban movement/undo, keyboard/touch input, rating UI, breeding workflow, generation history, experiment save/load (JSON files), localStorage persistence. Also contains `resolveVisualTheme()` which maps genome visual genes to rendering parameters (colors, shapes, patterns).
  - `levels.js` — 5 hardcoded tutorial levels.

**Key data flow:** `Population` → random bot selected as curator → curator picks genome via affinity → `Bot.generateLevel()` → `Genome.createGenerator()` → `SokobanGenerator.generate()` → player rates → `Population.evolve(fitnessScores)` → next generation.

## Key Design Constraints

- **Grids are always square** (width = height), enforced in `Genome.createGenerator()`.
- **Reverse-play guarantees solvability**: levels are generated by starting from a solved state and pulling boxes away. No forward solver exists.
- Generator uses progressive relaxation: after many failed attempts it reduces box count, lowers distance thresholds, and eventually falls back to a minimal level.
- All grid operations use flat arrays indexed as `y * width + x`.
- The `TILES` constants are used as raw integers in hot paths (e.g., `grid[nPos] !== 1` instead of `!== TILES.WALL` in `getPlayerReachable`).
- Visual theme is derived from genome at render time — the genome is the single source of truth for both level structure and appearance.
- Population state resets each page load by default (localStorage persistence code exists but is commented out in constructor).

## Docs

- `docs/machina_ludens_gdd.md` — Full game design document
- `ROADMAP.md` — Phase-based development plan with current status
- `EXPERIMENTS.md` / `RESULTS.md` — Cultural divergence experiment notes
- `docs/*.json` — Saved experiment data files
